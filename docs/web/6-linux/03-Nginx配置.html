<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NGINX配置</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="NGINX配置">
    <meta name="keywords" content="NGINX配置,NGINX,前端,alias,root,Nginx">
    <meta name="author" content="liam">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.e2f44ae9.css" as="style"><link rel="preload" href="/assets/js/app.04306d5f.js" as="script"><link rel="preload" href="/assets/js/2.c135791f.js" as="script"><link rel="preload" href="/assets/js/1.ef243348.js" as="script"><link rel="preload" href="/assets/js/87.cc7b4163.js" as="script"><link rel="prefetch" href="/assets/js/10.fac04ee2.js"><link rel="prefetch" href="/assets/js/11.df95b6d6.js"><link rel="prefetch" href="/assets/js/12.d322d79f.js"><link rel="prefetch" href="/assets/js/13.d461d101.js"><link rel="prefetch" href="/assets/js/14.eee8ad98.js"><link rel="prefetch" href="/assets/js/15.2da99dce.js"><link rel="prefetch" href="/assets/js/16.8066bbcc.js"><link rel="prefetch" href="/assets/js/17.0f456d45.js"><link rel="prefetch" href="/assets/js/18.87a15af9.js"><link rel="prefetch" href="/assets/js/19.8bf1456f.js"><link rel="prefetch" href="/assets/js/20.8e68410b.js"><link rel="prefetch" href="/assets/js/21.dbe112a9.js"><link rel="prefetch" href="/assets/js/22.58581544.js"><link rel="prefetch" href="/assets/js/23.40588304.js"><link rel="prefetch" href="/assets/js/24.10441e81.js"><link rel="prefetch" href="/assets/js/25.2e4373f1.js"><link rel="prefetch" href="/assets/js/26.2f0e64cf.js"><link rel="prefetch" href="/assets/js/27.d7aba204.js"><link rel="prefetch" href="/assets/js/28.2b3b1f1e.js"><link rel="prefetch" href="/assets/js/29.b9dd2f73.js"><link rel="prefetch" href="/assets/js/3.2be8686e.js"><link rel="prefetch" href="/assets/js/30.63ab944e.js"><link rel="prefetch" href="/assets/js/31.ccb9cd07.js"><link rel="prefetch" href="/assets/js/32.4c28795d.js"><link rel="prefetch" href="/assets/js/33.6dbc58b9.js"><link rel="prefetch" href="/assets/js/34.e980b0fa.js"><link rel="prefetch" href="/assets/js/35.66bb087a.js"><link rel="prefetch" href="/assets/js/36.523aeadc.js"><link rel="prefetch" href="/assets/js/37.3a422b4b.js"><link rel="prefetch" href="/assets/js/38.83aa08c6.js"><link rel="prefetch" href="/assets/js/39.6b8fd293.js"><link rel="prefetch" href="/assets/js/4.9be6b6a0.js"><link rel="prefetch" href="/assets/js/40.cee86fd6.js"><link rel="prefetch" href="/assets/js/41.a3e3f753.js"><link rel="prefetch" href="/assets/js/42.fed720d2.js"><link rel="prefetch" href="/assets/js/43.59c7b342.js"><link rel="prefetch" href="/assets/js/44.073ef3c8.js"><link rel="prefetch" href="/assets/js/45.86f4f9d6.js"><link rel="prefetch" href="/assets/js/46.5cc13eb6.js"><link rel="prefetch" href="/assets/js/47.357a7a48.js"><link rel="prefetch" href="/assets/js/48.881521a6.js"><link rel="prefetch" href="/assets/js/49.986588bb.js"><link rel="prefetch" href="/assets/js/5.740bd581.js"><link rel="prefetch" href="/assets/js/50.029beb12.js"><link rel="prefetch" href="/assets/js/51.b063c889.js"><link rel="prefetch" href="/assets/js/52.11b998a5.js"><link rel="prefetch" href="/assets/js/53.806ded8a.js"><link rel="prefetch" href="/assets/js/54.b2c8fa87.js"><link rel="prefetch" href="/assets/js/55.fd75e7d3.js"><link rel="prefetch" href="/assets/js/56.10885141.js"><link rel="prefetch" href="/assets/js/57.b864bbdd.js"><link rel="prefetch" href="/assets/js/58.3231dce5.js"><link rel="prefetch" href="/assets/js/59.fd092efe.js"><link rel="prefetch" href="/assets/js/6.b59cd7d8.js"><link rel="prefetch" href="/assets/js/60.97d3558d.js"><link rel="prefetch" href="/assets/js/61.de142641.js"><link rel="prefetch" href="/assets/js/62.b7533faf.js"><link rel="prefetch" href="/assets/js/63.852a8f24.js"><link rel="prefetch" href="/assets/js/64.da99cf99.js"><link rel="prefetch" href="/assets/js/65.8afa8c26.js"><link rel="prefetch" href="/assets/js/66.83471e32.js"><link rel="prefetch" href="/assets/js/67.a3fcc407.js"><link rel="prefetch" href="/assets/js/68.15d3a6ee.js"><link rel="prefetch" href="/assets/js/69.19b0a21d.js"><link rel="prefetch" href="/assets/js/7.f54d7af6.js"><link rel="prefetch" href="/assets/js/70.153e86d6.js"><link rel="prefetch" href="/assets/js/71.2926ae18.js"><link rel="prefetch" href="/assets/js/72.3e875735.js"><link rel="prefetch" href="/assets/js/73.df17dec8.js"><link rel="prefetch" href="/assets/js/74.c87c4aeb.js"><link rel="prefetch" href="/assets/js/75.19ceb5ca.js"><link rel="prefetch" href="/assets/js/76.05fd1bf1.js"><link rel="prefetch" href="/assets/js/77.2633441a.js"><link rel="prefetch" href="/assets/js/78.66fe72fe.js"><link rel="prefetch" href="/assets/js/79.67f744de.js"><link rel="prefetch" href="/assets/js/80.fbdf02fb.js"><link rel="prefetch" href="/assets/js/81.223e75d2.js"><link rel="prefetch" href="/assets/js/82.80b8ac05.js"><link rel="prefetch" href="/assets/js/83.27852ba9.js"><link rel="prefetch" href="/assets/js/84.b2878b41.js"><link rel="prefetch" href="/assets/js/85.c92b3dc1.js"><link rel="prefetch" href="/assets/js/86.67a90d02.js"><link rel="prefetch" href="/assets/js/88.9425155a.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.92fa0d62.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e2f44ae9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/header-logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/web/" class="nav-link router-link-active">
  Web
</a></div><div class="nav-item"><a href="/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  框架
</a></div><div class="nav-item"><a href="/other/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/huoyuhao/huoyuhao.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/web/" class="nav-link router-link-active">
  Web
</a></div><div class="nav-item"><a href="/network/" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  框架
</a></div><div class="nav-item"><a href="/other/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/huoyuhao/huoyuhao.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>代码规范</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Js基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Js进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Js安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DOM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mac</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>linux</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/web/6-linux/00-Linux常用命令.html" class="sidebar-link">Linux常用命令</a></li><li><a href="/web/6-linux/00-博客.html" class="sidebar-link">博客</a></li><li><a href="/web/6-linux/01-升级服务器.html" class="sidebar-link">升级服务器</a></li><li><a href="/web/6-linux/02-Node命令.html" class="sidebar-link">Node命令</a></li><li><a href="/web/6-linux/03-Nginx配置.html" class="active sidebar-link">Nginx配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_1-基础特点" class="sidebar-link">1. 基础特点</a></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_2-常用命令" class="sidebar-link">2. 常用命令</a></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_3-配置" class="sidebar-link">3. 配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_3-1-配置示例" class="sidebar-link">3.1 配置示例</a></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_3-2-全局块" class="sidebar-link">3.2 全局块</a></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_3-3-events块" class="sidebar-link">3.3 events块</a></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_3-4-http块" class="sidebar-link">3.4 http块</a></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_3-5-server块" class="sidebar-link">3.5 server块</a></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_3-6-location配置" class="sidebar-link">3.6 location配置</a></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_3-7-虚拟目录alias和root" class="sidebar-link">3.7 虚拟目录alias和root</a></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_3-8-端口转发" class="sidebar-link">3.8 端口转发</a></li></ul></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_4-内置变量" class="sidebar-link">4. 内置变量</a></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_5-负载均衡" class="sidebar-link">5. 负载均衡</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_5-1-轮询" class="sidebar-link">5.1 轮询</a></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_5-2-最小连接数策略" class="sidebar-link">5.2 最小连接数策略</a></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_5-3-ip-hash策略" class="sidebar-link">5.3 IP Hash策略</a></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_5-4-指定权重" class="sidebar-link">5.4 指定权重</a></li><li class="sidebar-sub-header"><a href="/web/6-linux/03-Nginx配置.html#_5-3-最快响应时间策略" class="sidebar-link">5.3 最快响应时间策略</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx配置"><a href="#nginx配置" class="header-anchor">#</a> NGINX配置</h1> <h2 id="_1-基础特点"><a href="#_1-基础特点" class="header-anchor">#</a> 1. 基础特点</h2> <ul><li>Nginx 专为性能优化而开发。
<ul><li>性能是其最重要的考量,实现上非常注重效率 。它支持内核 Poll 模型，能经受高负载的考验,有报告表明能支持高达 50,000 个并发连接数。</li></ul></li> <li>Nginx 具有很高的稳定性。
<ul><li>其它 HTTP 服务器，当遇到访问的峰值，或者有人恶意发起慢速连接时，很可能会导致服务器物理内存耗尽频繁交换，失去响应，只能重启服务器。例如当前 apache 一旦上到 200 个进程以上，web响应速度就明显非常缓慢了。而 Nginx 采取了分阶段资源分配技术，使得它的 CPU 与内存占用率非常低。</li> <li>Nginx 官方表示在保持 10,000 个无活动连接时，它只占 2.5M 内存，所以类似 DOS 这样的攻击对 Nginx 来说基本上是毫无用处的。就稳定性而言，Nginx 比 lighthttpd 更胜一筹。</li></ul></li> <li>Nginx 支持热部署。
<ul><li>它的启动特别容易, 并且几乎可以做到 7*24 不间断运行，即使运行数个月也不需要重新启动。</li> <li>你还能够在不间断服务的情况下，对软件版本进行升级。</li></ul></li></ul> <h2 id="_2-常用命令"><a href="#_2-常用命令" class="header-anchor">#</a> 2. 常用命令</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># nginx配置文件位置</span>
<span class="token builtin class-name">cd</span> /etc/nginx/conf.d

<span class="token comment"># nginx的启动</span>
systemctl start nginx
<span class="token comment"># 热加载，重新加载配置文件</span>
nginx <span class="token parameter variable">-s</span> reload

<span class="token comment"># 测试nginx是否正常</span>
nginx –t
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="_3-配置"><a href="#_3-配置" class="header-anchor">#</a> 3. 配置</h2> <h3 id="_3-1-配置示例"><a href="#_3-1-配置示例" class="header-anchor">#</a> 3.1 配置示例</h3> <div class="language-config line-numbers-mode"><pre class="language-text"><code>#指令名 指令值;  #全局块，主要设置Nginx服务器整体运行的配置指令
worker_processes  1;

#events块,主要设置,Nginx服务器与用户的网络连接,这一部分对Nginx服务器的性能影响较大
events {
  worker_connections  1024;
}

#http块，是Nginx服务器配置中的重要部分，代理、缓存、日志记录、第三方模块配置...  
http {

  #指令名 指令值;
  include       mime.types;
  default_type  application/octet-stream;
  sendfile        on;
  keepalive_timeout  65;

  #server块，是Nginx配置和虚拟主机相关的内容
  server {
    listen       80;
    server_name  localhost;
    
    #location块，基于Nginx服务器接收请求字符串与location后面的值进行匹配，对特定请求进行处理
    location / {
      #指令名 指令值;
      root   html;
      index  index.html index.htm;
    }
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
      root   html;
    }
  }

}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>nginx.conf配置文件中默认有三大块：全局块、events块、http块</p> <p>http块中可以配置多个server块，每个server块又可以配置多个location块</p> <h3 id="_3-2-全局块"><a href="#_3-2-全局块" class="header-anchor">#</a> 3.2 全局块</h3> <p>全局块是默认配置文件从开始到events块之间的一部分内容，主要设置一些影响Nginx服务器整体运行的配置指令，因此，这些指令的作用域是Nginx服务器全局。</p> <p>通常包括配置运行Nginx服务器的用户（组）、允许生成的worker process数、Nginx进程PID存放路径、日志的存放路径和类型以及配置文件引入等</p> <h3 id="_3-3-events块"><a href="#_3-3-events块" class="header-anchor">#</a> 3.3 events块</h3> <p>events块涉及的指令主要影响Nginx服务器与用户的网络连接。常用到的设置包括是否开启对多worker process下的网络连接进行序列化，是否允许同时接收多个网络连接，选取哪种事件驱动模型处理连接请求，每个worker process可以同时支持的最大连接数等。</p> <p>这一部分的指令对Nginx服务器的性能影响较大，在实际配置中应该根据实际情况灵活调整</p> <h3 id="_3-4-http块"><a href="#_3-4-http块" class="header-anchor">#</a> 3.4 http块</h3> <p>http块是Nginx服务器配置中的重要部分，代理、缓存和日志定义等绝大多数的功能和第三方模块的配置都可以放在这个模块中。</p> <p>前面已经提到，http块中可以包含自己的全局块，也可以包含server块，server块中又可以进一步包含location块，在本书中我们使用“http全局块”来表示http中自己的全局块，即http块中不包含在server块中的部分。</p> <p>可以在http全局块中配置的指令包括文件引入、MIME-Type定义、日志自定义、是否使用sendfile传输文件、连接超时时间、单连接请求数上限等。</p> <h3 id="_3-5-server块"><a href="#_3-5-server块" class="header-anchor">#</a> 3.5 server块</h3> <p>server块和“虚拟主机”的概念有密切联系。</p> <p>虚拟主机，又称虚拟服务器、主机空间或是网页空间，它是一种技术。该技术是为了节省互联网服务器硬件成本而出现的。这里的“主机”或“空间”是由实体的服务器延伸而来，硬件系统可以基于服务器群，或者单个服务器等。虚拟主机技术主要应用于HTTP、FTP及EMAIL等多项服务，将一台服务器的某项或者全部服务内容逻辑划分为多个服务单位，对外表现为多个服务器，从而充分利用服务器硬件资源。从用户角度来看，一台虚拟主机和一台独立的硬件主机是完全一样的。</p> <p>在使用Nginx服务器提供Web服务时，利用虚拟主机的技术就可以避免为每一个要运行的网站提供单独的Nginx服务器，也无需为每个网站对应运行一组Nginx进程。虚拟主机技术使得Nginx服务器可以在同一台服务器上只运行一组Nginx进程，就可以运行多个网站。</p> <p>在前面提到过，每一个http块都可以包含多个server块，而每个server块就相当于一台虚拟主机，它内部可有多台主机联合提供服务，一起对外提供在逻辑上关系密切的一组服务（或网站）。</p> <p>和http块相同，server块也可以包含自己的全局块，同时可以包含多个location块。在server全局块中，最常见的两个配置项是本虚拟主机的监听配置和本虚拟主机的名称或IP配置。</p> <div class="language-config line-numbers-mode"><pre class="language-text"><code>server {
  listen              443 ssl http2;
  listen              [::]:443 ssl http2;
  server_name         domain.com *.domain.com;
  root                /var/www/domain/dist;
  # SSL
  ssl_certificate     /etc/nginx/ssl/domain.com.pem;
  ssl_certificate_key /etc/nginx/ssl/domain.com.key;
  # security
  include             sites-available/security.conf;
  # index.html fallback
  location / {
    try_files $uri $uri/ /index.html;
  }
  # reverse proxy
  location /api/ {
    proxy_pass http://127.0.0.1:8080/;
    include    sites-available/proxy.conf;
  }
  # allow safe files
  location ~* \.(?:css(\.map)?|js(\.map)?|ttf|ttc|otf|eot|woff2?|svgz?|jpe?g|png|gif|ico|cur|heic|webp|tiff?|mp3|m4a|aac|ogg|midi?|wav|mp4|mov|webm|mpe?g|avi|ogv|flv|wmv|pdf|docx?|dotx?|docm|dotm|xlsx?|xltx?|xlsm|xltm|pptx?|potx?|pptm|potm|ppsx?)$ {
    add_header Access-Control-Allow-Origin &quot;*&quot;;
    add_header Cache-Control &quot;public&quot;;
    expires    30d;
  }
  # additional config
  include sites-available/general.conf;
}
# HTTP redirect
server {
  listen      80;
  listen      [::]:80;
  server_name .domain.com;
  return      301 https://domain.com$request_uri;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><div class="language-config line-numbers-mode"><pre class="language-text"><code># gzip
gzip            on;
gzip_vary       on;
gzip_proxied    any;
gzip_comp_level 6;
gzip_types      text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_3-6-location配置"><a href="#_3-6-location配置" class="header-anchor">#</a> 3.6 location配置</h3> <h4 id="_3-6-1-location-配置"><a href="#_3-6-1-location-配置" class="header-anchor">#</a> 3.6.1 location 配置</h4> <div class="language-config line-numbers-mode"><pre class="language-text"><code>location [ = | ~ | ~* | ^~ ] uri { ... }
location @name { ... }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>修饰符匹配优先级从高到低依次为</p> <ul><li><code>location =</code> 表示精确匹配。只有请求的url路径与后面的字符串完全相等时，才会命中。如果已经匹配成功，就停止继续向下搜索并立即处理此请求</li> <li><code>location ^~</code> 表示如果该符号后面的字符是最佳匹配，采用该规则，不再进行后续的查找</li> <li><code>location ~</code> 表示该规则是使用正则定义的，区分大小写</li> <li><code>location ~*</code> 表示该规则是使用正则定义的，不区分大小写</li> <li><code>location /a</code> 普通前缀匹配，优先级低于带参数前缀匹配</li> <li><code>location /</code> 任何没有匹配成功的，都会匹配这里处理</li></ul> <p>注意：在浏览器传送URI时对一部分字符进行URL编码，比如空格被编码为<code>%20</code>，问号被编码为<code>%3f</code>等。<code>～</code>有一个特点是，它对uri中的这些符号将会进行编码处理。比如，如果location块收到的URI为<code>/html/%20/data</code>，则当Nginx服务器搜索到配置为<code>～ /html/ /data</code>的location时，可以匹配成功</p> <h4 id="_3-6-2-location-案例分析"><a href="#_3-6-2-location-案例分析" class="header-anchor">#</a> 3.6.2 location 案例分析</h4> <div class="language-conf line-numbers-mode"><pre class="language-text"><code>server {
  server_name liam.com;
  location ^~ /document {
    return 701; # 用这样的方式，可以方便的知道请求到了哪里
  }
  location /doc {
    return 702;
  }
  location ~* ^/doc$ {
    return 703; 
  }

  location /use {
    return 704;
  }
  location /user {
    return 705;
  }

  location ~ ^/tes[a-z]+ {
    return 706;
  }
  location ~ ^/te[a-z]+ {
    return 707;
  }

  location ~ ^/ima[a-z]+ {
    return 708;
  }

  location ~ ^/image[a-z]+ {
    return 709;
  }
}
# 修改本机hosts文件 127.0.0.1 liam.com
# curl -I liam.com/document 查看返回码，可以方便的知道请求到了哪里
liam.com/document 701 ^~ 命中以后不会再搜寻正则匹配
liam.com/doc 703 ^~ 按照上述的规则，显然第三个正则匹配会有更高的优先级
liam.com/userName 705 前缀匹配下，返回最长匹配的 location，与 location 所在位置顺序无关
liam.com/test 706 
liam.com/images 708 正则匹配是使用文件中的顺序，先匹配成功的返回
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h4 id="_3-6-3-location-uri结尾带不带"><a href="#_3-6-3-location-uri结尾带不带" class="header-anchor">#</a> 3.6.3 location URI结尾带不带 /</h4> <p>关于 URI 尾部的 / 有三点也需要说明一下。第一点与 location 配置有关，其他两点无关。</p> <ul><li>location 中的字符有没有 / 都没有影响。也就是说 /user/ 和 /user 是一样的。</li> <li>如果 URI 结构是 <code>https://liam.com/</code> 的形式，尾部有没有 / 都不会造成重定向。因为浏览器在发起请求的时候，默认加上了 / 。虽然很多浏览器在地址栏里也不会显示 / 。这一点，可以访问baidu验证一下。
如果 URI 的结构是 <code>https://liam.com/some-dir/</code> 。尾部如果缺少 / 将导致重定向。因为根据约定，URL 尾部的 / 表示目录，没有 / 表示文件。所以访问 <code>/some-dir/</code> 时，服务器会自动去该目录下找对应的默认文件。如果访问 <code>/some-dir</code> 的话，服务器会先去找 <code>some-dir</code> 文件，找不到的话会将 <code>some-dir</code> 当成目录，重定向到 <code>/some-dir/</code>，去该目录下找默认文件。</li></ul> <h4 id="_3-6-4-location-name的用法"><a href="#_3-6-4-location-name的用法" class="header-anchor">#</a> 3.6.4 location @name的用法</h4> <p>@用来定义一个命名location。主要用于内部重定向，不能用来处理正常的请求。其用法如下</p> <div class="language-conf line-numbers-mode"><pre class="language-text"><code>location / {
  try_files $uri $uri/ @custom
}
location @custom {
  # ...do something
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_3-7-虚拟目录alias和root"><a href="#_3-7-虚拟目录alias和root" class="header-anchor">#</a> 3.7 虚拟目录alias和root</h3> <ul><li><code>alias</code>指定的目录是准确的，即location匹配访问的path目录下的文件直接是在alias目录下查找的；</li> <li><code>root</code>指定的目录是location匹配访问的path目录的上一级目录，这个path目录一定要是真实存在root指定目录下的；</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /data 目录</span>
<span class="token operator">|</span>--img
  <span class="token operator">|</span>--logo.png
  <span class="token operator">|</span>--header.png
<span class="token operator">|</span>--images
  <span class="token operator">|</span>--banner.png
  <span class="token operator">|</span>--index.png
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-config line-numbers-mode"><pre class="language-text"><code>location /test/ {
  alias /data/images/;
}
# http://XXX.com/test/banner.png 访问成功
# alias虚拟目录配置中，location匹配的path目录如果后面不带&quot;/&quot;，那么访问的url地址中这个path目录后面加不加&quot;/&quot;不影响访问，访问时它会自动加上&quot;/&quot;；
# 但是如果location匹配的path目录后面加上&quot;/&quot;，那么访问的url地址中这个path目录必须要加上&quot;/&quot;，访问时它不会自动加上&quot;/&quot;。如果不加上&quot;/&quot;，访问就会失败！
# 即 /test/ alias /data/images 会导致访问失败

location ~ ^/im[a-z]+/ {
  root /data/;
}
# http://XXX.com/images/banner.png 访问成功
# http://XXX.com/img/logo.png 访问成功
# root目录配置中，location匹配的path目录后面带不带&quot;/&quot;，都不会影响访问。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_3-8-端口转发"><a href="#_3-8-端口转发" class="header-anchor">#</a> 3.8 端口转发</h3> <div class="language-config line-numbers-mode"><pre class="language-text"><code>server{
  listen 80;
  server_name  liam.com;
  index  index.php index.html index.htm;

  location / {
    proxy_pass  http://liamhuo.com:8080;

    # 保留代理之前的host 包含客户端真实的域名和端口号
    proxy_set_header Host $proxy_host;

    # 保留代理之前的真实客户端ip
    proxy_set_header X-Real-IP $remote_addr;
    
    # 这个Header和X-Real-IP类似，但它在多级代理时会包含真实客户端及中间每个代理服务器的IP
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # 表示客户端真实的协议（http还是https）
    proxy_set_header X-Forwarded-Proto $scheme;
  }
  location /data/ {
    proxy_pass  http://liamhuo.com/;
  }
  location /user/ {
    proxy_pass  http://liamhuo.com;
  }
  # 在配置proxy_pass代理转发时，如果后面的url加/，表示绝对根路径；如果没有/，表示相对路径
  # liam.com/data/index.html =&gt; liamhuo.com/index.html
  # liam.com/user/index.html =&gt; liamhuo.com/user/index.html
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="_4-内置变量"><a href="#_4-内置变量" class="header-anchor">#</a> 4. 内置变量</h2> <table><thead><tr><th>变量名</th> <th>功能</th></tr></thead> <tbody><tr><td>$host</td> <td>请求信息中的Host，如果请求中没有Host行，则等于设置的服务器名$request_method</td></tr> <tr><td>$remote_addr</td> <td>客户端的IP地址</td></tr> <tr><td>$args</td> <td>请求中的参数</td></tr> <tr><td>$content_length</td> <td>请求头中的Content-length字段</td></tr> <tr><td>$http_user_agent</td> <td>客户端agent信息</td></tr> <tr><td>$http_cookie</td> <td>客户端cookie信息</td></tr> <tr><td>$remote_port</td> <td>客户端的端口</td></tr> <tr><td>$server_protocol</td> <td>请求使用的协议，如HTTP/1.0、·HTTP/1.1`</td></tr> <tr><td>$server_addr</td> <td>服务器地址</td></tr> <tr><td>$server_name</td> <td>服务器名称</td></tr> <tr><td>$server_port</td> <td>服务器的端口号</td></tr></tbody></table> <h2 id="_5-负载均衡"><a href="#_5-负载均衡" class="header-anchor">#</a> 5. 负载均衡</h2> <p>负载均衡就是用来帮助我们将众多的客户端请求合理的分配到各个服务器，以达到服务端资源的充分利用和更少的请求时间。</p> <p>Upstream指定后端服务器地址列表</p> <div class="language-config line-numbers-mode"><pre class="language-text"><code>upstream balanceServer {
  server 10.1.22.33:12345;
  server 10.1.22.34:12345;
  server 10.1.22.35:12345;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在server中拦截响应请求，并将请求转发到Upstream中配置的服务器列表。</p> <div class="language-config line-numbers-mode"><pre class="language-text"><code>server {
  server_name  fe.server.com;
  listen 80;
  location /api {
    proxy_pass http://balanceServer;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>上面的配置只是指定了nginx需要转发的服务端列表，并没有指定分配策略</p> <h3 id="_5-1-轮询"><a href="#_5-1-轮询" class="header-anchor">#</a> 5.1 轮询</h3> <p>默认的策略，每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</p> <div class="language-config line-numbers-mode"><pre class="language-text"><code>upstream balanceServer {
  server 10.1.22.33:12345;
  server 10.1.22.34:12345;
  server 10.1.22.35:12345;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_5-2-最小连接数策略"><a href="#_5-2-最小连接数策略" class="header-anchor">#</a> 5.2 最小连接数策略</h3> <p>将请求优先分配给压力较小的服务器，它可以平衡每个队列的长度，并避免向压力大的服务器添加更多的请求</p> <div class="language-config line-numbers-mode"><pre class="language-text"><code>upstream balanceServer {
  least_conn;
  server 10.1.22.33:12345;
  server 10.1.22.34:12345;
  server 10.1.22.35:12345;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_5-3-ip-hash策略"><a href="#_5-3-ip-hash策略" class="header-anchor">#</a> 5.3 IP Hash策略</h3> <p>每个请求按访问IP的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。</p> <div class="language-config line-numbers-mode"><pre class="language-text"><code>upstream balanceServer {
  ip_hash;
  server 10.1.22.33:12345;
  server 10.1.22.34:12345;
  server 10.1.22.35:12345;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_5-4-指定权重"><a href="#_5-4-指定权重" class="header-anchor">#</a> 5.4 指定权重</h3> <ul><li>weight代表权重，权重越高，被分配到的客户端越多。</li> <li>用于后端服务器性能不均的情况，性能高的服务器将分配更多的客户端</li></ul> <div class="language-config line-numbers-mode"><pre class="language-text"><code>upstream backserver {
  server 192.168.0.14 weight=3;
  server 192.168.0.15 weight=7;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_5-3-最快响应时间策略"><a href="#_5-3-最快响应时间策略" class="header-anchor">#</a> 5.3 最快响应时间策略</h3> <ul><li>依赖于NGINX Plus，优先分配给响应时间最短的服务器</li> <li>fair策略是扩展策略，默认不被编译进nginx内核。它根据后端服务器的响应时间判断负载情况，从中选出负载最轻的机器进行分流。</li> <li>这种策略具有很强的自适应性，但是实际的网络环境往往不是那么简单，因此须慎用</li> <li>nginx的默认模块中是不支持的，需要下载 nginx-upstream-fair 模块</li></ul> <div class="language-config line-numbers-mode"><pre class="language-text"><code>upstream balanceServer {
  fair;
  server 10.1.22.33:12345;
  server 10.1.22.34:12345;
  server 10.1.22.35:12345;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/21/2025, 10:04:32 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/web/6-linux/02-Node命令.html" class="prev">
        Node命令
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.04306d5f.js" defer></script><script src="/assets/js/2.c135791f.js" defer></script><script src="/assets/js/1.ef243348.js" defer></script><script src="/assets/js/87.cc7b4163.js" defer></script>
  </body>
</html>
